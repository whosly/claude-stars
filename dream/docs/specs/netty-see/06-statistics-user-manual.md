# Netty-See 统计分析功能用户手册

## 📊 **功能概述**

统计分析功能是Netty-See的核心功能之一，提供了全方位的数据聚合、统计分析和可视化展示能力。通过多维度的统计分析，帮助用户深入了解Netty应用的运行状态、性能表现和潜在问题。

## 🎯 **主要特性**

### 1. 多维度统计
- **时间维度**: 分钟级、小时级、天级统计
- **应用维度**: 按应用名称分组统计
- **EventLoop维度**: 按EventLoop类型分组统计
- **地理维度**: 按IP地址区域分组统计

### 2. 实时数据聚合
- **连接统计**: 总连接数、活跃连接数、峰值连接数
- **性能指标**: TPS、QPS、平均响应时间、错误率
- **数据传输**: 字节传输量、消息数量、吞吐量
- **资源使用**: 缓冲区利用率、内存使用情况

### 3. 智能分析
- **趋势分析**: 历史数据趋势和预测
- **异常检测**: 自动识别异常模式
- **负载分析**: EventLoop负载均衡分析
- **性能诊断**: 性能瓶颈识别和建议

## 🖥️ **界面使用指南**

### 访问统计页面
1. 打开Netty-See主页: `http://localhost:8081`
2. 点击导航栏中的"统计分析"或直接访问: `http://localhost:8081/statistics`

### 页面布局说明

#### 1. 时间范围选择器
位于页面顶部，支持以下时间范围：
- **5分钟**: 查看最近5分钟的详细数据
- **30分钟**: 查看最近30分钟的数据趋势
- **1小时**: 默认选项，查看最近1小时的数据
- **6小时**: 查看较长时间的趋势变化
- **24小时**: 查看全天的数据概览

#### 2. 实时统计卡片
显示四个关键指标的实时数据：
- **活跃连接**: 当前活跃的连接数量
- **总请求数**: 累计处理的请求总数
- **平均响应时间**: 请求的平均处理时间
- **错误率**: 错误请求占总请求的百分比

#### 3. 趋势图表区域

##### 连接数趋势图
- **蓝线**: 活跃连接数变化趋势
- **红线**: 峰值连接数变化趋势
- **用途**: 监控连接数波动，识别流量高峰

##### 吞吐量趋势图
- **蓝线**: TPS (每秒事务数)
- **黄线**: QPS (每秒查询数)
- **用途**: 监控系统处理能力和负载变化

##### 响应时间分布图
- **柱状图**: 不同响应时间区间的请求分布
- **区间**: 0-10ms, 10-50ms, 50-100ms, 100-500ms, 500ms+
- **用途**: 分析响应时间分布，识别性能问题

##### 错误统计图
- **饼图**: 成功请求与错误请求的比例
- **绿色**: 成功请求
- **红色**: 错误请求
- **用途**: 直观显示系统健康状态

#### 4. 应用统计表格
显示各个应用的详细统计信息：

| 列名 | 说明 |
|------|------|
| 应用名称 | 监控的应用标识 |
| 当前连接 | 该应用当前的活跃连接数 |
| 峰值连接 | 该应用历史最高连接数 |
| 总请求数 | 该应用处理的总请求数 |
| 成功率 | 成功请求占总请求的百分比 |
| 平均响应时间 | 该应用的平均响应时间 |
| 吞吐量 | 该应用的TPS值 |
| 状态 | 应用健康状态（正常/警告/异常） |

#### 5. EventLoop统计表格
显示各个EventLoop的性能统计：

| 列名 | 说明 |
|------|------|
| EventLoop | EventLoop的名称或标识 |
| 当前Channel | 该EventLoop当前管理的Channel数 |
| 峰值Channel | 该EventLoop历史最高Channel数 |
| 队列大小 | 任务队列中待处理的任务数 |
| CPU使用率 | 该EventLoop的CPU使用百分比 |
| 平均负载 | 综合负载指标 |
| 错误率 | 该EventLoop的错误处理率 |
| 状态 | EventLoop状态（正常/需重平衡/过载） |

## 🔧 **API接口使用**

### 1. 实时统计接口
```http
GET /api/statistics/realtime
```

**响应示例**:
```json
{
  "windowStart": "2024-12-19T10:30:00",
  "windowEnd": "2024-12-19T10:31:00",
  "totalConnections": 150,
  "activeConnections": 120,
  "peakConnections": 180,
  "totalBytes": 1048576,
  "totalRequests": 500,
  "successfulRequests": 485,
  "errorRate": 3.0,
  "avgResponseTime": 45.2,
  "tps": 8.1,
  "qps": 8.3,
  "bytesPerSecond": 17476.3
}
```

### 2. 时间范围统计接口
```http
GET /api/statistics/timerange?start=2024-12-19T09:00:00&end=2024-12-19T10:00:00&granularity=minute
```

**参数说明**:
- `start`: 开始时间 (ISO 8601格式)
- `end`: 结束时间 (ISO 8601格式)
- `granularity`: 时间粒度 (minute/hour/day)

### 3. 最近N分钟统计接口
```http
GET /api/statistics/recent/60
```

### 4. 应用统计接口
```http
GET /api/statistics/applications
GET /api/statistics/applications/{applicationName}
```

### 5. EventLoop统计接口
```http
GET /api/statistics/eventloops
GET /api/statistics/eventloops/{eventLoopName}
```

### 6. 统计概览接口
```http
GET /api/statistics/overview
```

### 7. 性能指标接口
```http
GET /api/statistics/performance
```

### 8. 错误统计接口
```http
GET /api/statistics/errors
```

## 📈 **数据解读指南**

### 1. 连接数分析

#### 正常模式
- 连接数相对稳定，有规律的波动
- 峰值连接数不超过系统容量的80%
- 连接建立和关闭比较均衡

#### 异常模式
- **连接泄漏**: 连接数持续增长不下降
- **连接风暴**: 短时间内连接数急剧增加
- **连接不稳定**: 连接数频繁大幅波动

### 2. 性能指标分析

#### TPS/QPS分析
- **正常范围**: 根据业务特点确定基线值
- **性能下降**: TPS/QPS显著低于基线
- **容量瓶颈**: TPS/QPS达到平台期无法提升

#### 响应时间分析
- **优秀**: 95%请求在50ms内完成
- **良好**: 95%请求在100ms内完成
- **需优化**: 95%请求超过200ms
- **严重问题**: 平均响应时间超过500ms

### 3. 错误率分析

#### 错误率阈值
- **健康**: 错误率 < 0.1%
- **警告**: 0.1% ≤ 错误率 < 1%
- **异常**: 1% ≤ 错误率 < 5%
- **严重**: 错误率 ≥ 5%

### 4. EventLoop负载分析

#### 负载均衡评估
- **均衡**: 各EventLoop的Channel数量相近
- **轻微不均**: 最大与最小差异 < 20%
- **需重平衡**: 最大与最小差异 > 50%
- **严重不均**: 某个EventLoop负载 > 80%

## 🚨 **告警和监控建议**

### 1. 关键指标监控

#### 连接数监控
```yaml
告警规则:
  - 活跃连接数 > 系统容量的80%
  - 连接数增长率 > 100%/分钟
  - 连接数持续增长超过10分钟
```

#### 性能监控
```yaml
告警规则:
  - 平均响应时间 > 200ms
  - TPS下降 > 50%
  - 错误率 > 1%
  - P95响应时间 > 500ms
```

#### 资源监控
```yaml
告警规则:
  - EventLoop负载不均衡 > 50%
  - 任务队列积压 > 1000
  - 缓冲区利用率 > 90%
```

### 2. 监控最佳实践

#### 基线建立
1. **收集历史数据**: 至少观察1周的正常运行数据
2. **确定基线值**: 计算各指标的平均值和标准差
3. **设置阈值**: 基于基线值设置合理的告警阈值
4. **定期调整**: 根据业务变化调整基线和阈值

#### 趋势分析
1. **日常监控**: 关注实时指标和短期趋势
2. **周期分析**: 每周分析性能趋势和异常模式
3. **容量规划**: 基于历史趋势预测未来容量需求
4. **优化建议**: 根据分析结果提出系统优化建议

## 🔍 **故障排查指南**

### 1. 性能问题排查

#### 响应时间过长
1. **检查EventLoop负载**: 是否存在负载不均衡
2. **分析请求分布**: 查看响应时间分布图
3. **检查错误率**: 是否有大量错误影响性能
4. **查看资源使用**: 缓冲区和内存使用情况

#### TPS/QPS下降
1. **对比历史数据**: 确定下降的时间点和幅度
2. **检查连接数**: 是否连接数也同时下降
3. **分析错误统计**: 是否错误率上升导致TPS下降
4. **查看应用统计**: 确定是全局问题还是特定应用问题

### 2. 连接问题排查

#### 连接泄漏
1. **查看连接趋势**: 确认连接数持续增长
2. **检查应用统计**: 确定哪个应用存在泄漏
3. **分析EventLoop分布**: 查看连接在EventLoop间的分布
4. **检查错误日志**: 查找连接关闭相关的错误

#### 连接不稳定
1. **查看连接波动模式**: 分析波动的周期和幅度
2. **检查网络状况**: 是否存在网络问题
3. **分析客户端行为**: 是否客户端连接策略有问题
4. **查看服务器资源**: 是否服务器资源不足

## 💡 **优化建议**

### 1. 性能优化

#### 基于统计数据的优化
- **EventLoop调优**: 根据负载分布调整EventLoop数量
- **缓冲区优化**: 根据使用情况调整缓冲区大小
- **连接池优化**: 根据连接模式优化连接池配置
- **业务逻辑优化**: 根据响应时间分布优化处理逻辑

### 2. 监控优化

#### 采样策略优化
- **动态采样**: 根据系统负载动态调整采样率
- **分级采样**: 对不同类型的事件使用不同采样率
- **智能过滤**: 过滤掉不重要的监控数据

#### 存储优化
- **数据压缩**: 对历史数据进行压缩存储
- **分层存储**: 不同时间粒度使用不同存储策略
- **自动清理**: 定期清理过期的统计数据

## 📚 **扩展阅读**

### 相关文档
- [Netty-See 架构设计](./architecture.md)
- [功能实现状态](./implementation-status.md)
- [深度功能分析](./deep-analysis-missing-features.md)

### 技术参考
- [Netty官方文档](https://netty.io/wiki/)
- [Java并发编程](https://docs.oracle.com/javase/tutorial/essential/concurrency/)
- [时序数据库设计](https://en.wikipedia.org/wiki/Time_series_database)

---

**版本**: v1.0  
**更新时间**: 2024-12-19  
**作者**: Netty-See开发团队"