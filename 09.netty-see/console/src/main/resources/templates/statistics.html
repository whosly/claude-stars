<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计分析 - Netty See</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stats-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stats-card p {
            margin-bottom: 0;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .metric-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
        }
        
        .metric-success { background-color: #d4edda; color: #155724; }
        .metric-warning { background-color: #fff3cd; color: #856404; }
        .metric-danger { background-color: #f8d7da; color: #721c24; }
        .metric-info { background-color: #d1ecf1; color: #0c5460; }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .time-selector {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>Netty See - 统计分析
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home me-1"></i>首页</a>
                <a class="nav-link" href="/channels"><i class="fas fa-network-wired me-1"></i>连接</a>
                <a class="nav-link" href="/performance"><i class="fas fa-tachometer-alt me-1"></i>性能</a>
                <a class="nav-link active" href="/statistics"><i class="fas fa-chart-bar me-1"></i>统计</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 时间选择器 -->
        <div class="time-selector">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>时间范围</h5>
                </div>
                <div class="col-md-6">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="setTimeRange(5)">5分钟</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimeRange(30)">30分钟</button>
                        <button type="button" class="btn btn-outline-primary active" onclick="setTimeRange(60)">1小时</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimeRange(360)">6小时</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTimeRange(1440)">24小时</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 实时统计卡片 -->
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="activeConnections">0</h3>
                    <p><i class="fas fa-plug me-2"></i>活跃连接</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="totalRequests">0</h3>
                    <p><i class="fas fa-exchange-alt me-2"></i>总请求数</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="avgResponseTime">0ms</h3>
                    <p><i class="fas fa-clock me-2"></i>平均响应时间</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="errorRate">0%</h3>
                    <p><i class="fas fa-exclamation-triangle me-2"></i>错误率</p>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2"></i>连接数趋势</h5>
                    <canvas id="connectionChart" height="300"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-tachometer-alt me-2"></i>吞吐量趋势</h5>
                    <canvas id="throughputChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-stopwatch me-2"></i>响应时间分布</h5>
                    <canvas id="responseTimeChart" height="300"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-bug me-2"></i>错误统计</h5>
                    <canvas id="errorChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- 应用统计表格 -->
        <div class="table-container">
            <h5><i class="fas fa-apps me-2"></i>应用统计</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>应用名称</th>
                            <th>当前连接</th>
                            <th>峰值连接</th>
                            <th>总请求数</th>
                            <th>成功率</th>
                            <th>平均响应时间</th>
                            <th>吞吐量</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="applicationStatsTable">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- EventLoop统计表格 -->
        <div class="table-container mt-4">
            <h5><i class="fas fa-cogs me-2"></i>EventLoop统计</h5>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>EventLoop</th>
                            <th>当前Channel</th>
                            <th>峰值Channel</th>
                            <th>队列大小</th>
                            <th>CPU使用率</th>
                            <th>平均负载</th>
                            <th>错误率</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="eventLoopStatsTable">
                        <!-- 动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 刷新按钮 -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshData()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTimeRange = 60; // 默认1小时
        let charts = {};
        
        // 初始化图表
        function initCharts() {
            // 连接数趋势图
            const connectionCtx = document.getElementById('connectionChart').getContext('2d');
            charts.connection = new Chart(connectionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '活跃连接',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: '峰值连接',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 吞吐量趋势图
            const throughputCtx = document.getElementById('throughputChart').getContext('2d');
            charts.throughput = new Chart(throughputCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'TPS',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'QPS',
                        data: [],
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 响应时间分布图
            const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
            charts.responseTime = new Chart(responseTimeCtx, {
                type: 'bar',
                data: {
                    labels: ['0-10ms', '10-50ms', '50-100ms', '100-500ms', '500ms+'],
                    datasets: [{
                        label: '请求数量',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // 错误统计图
            const errorCtx = document.getElementById('errorChart').getContext('2d');
            charts.error = new Chart(errorCtx, {
                type: 'doughnut',
                data: {
                    labels: ['成功', '错误'],
                    datasets: [{
                        data: [100, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // 设置时间范围
        function setTimeRange(minutes) {
            currentTimeRange = minutes;
            
            // 更新按钮状态
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 刷新数据
            refreshData();
        }

        // 刷新数据
        function refreshData() {
            // 旋转刷新按钮
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            Promise.all([
                loadRealTimeStats(),
                loadTrendData(),
                loadApplicationStats(),
                loadEventLoopStats()
            ]).finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        // 加载实时统计
        function loadRealTimeStats() {
            return fetch('/api/statistics/realtime')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('activeConnections').textContent = data.activeConnections || 0;
                    document.getElementById('totalRequests').textContent = data.totalRequests || 0;
                    document.getElementById('avgResponseTime').textContent = 
                        (data.avgResponseTime || 0).toFixed(1) + 'ms';
                    document.getElementById('errorRate').textContent = 
                        (data.errorRate || 0).toFixed(1) + '%';
                })
                .catch(error => {
                    console.error('Error loading real-time stats:', error);
                });
        }

        // 加载趋势数据
        function loadTrendData() {
            return fetch(`/api/statistics/recent/${currentTimeRange}`)
                .then(response => response.json())
                .then(data => {
                    updateTrendCharts(data);
                })
                .catch(error => {
                    console.error('Error loading trend data:', error);
                });
        }

        // 更新趋势图表
        function updateTrendCharts(data) {
            const labels = data.map(item => {
                const date = new Date(item.windowStart);
                return date.toLocaleTimeString();
            });

            // 更新连接数趋势
            charts.connection.data.labels = labels;
            charts.connection.data.datasets[0].data = data.map(item => item.activeConnections);
            charts.connection.data.datasets[1].data = data.map(item => item.peakConnections);
            charts.connection.update();

            // 更新吞吐量趋势
            charts.throughput.data.labels = labels;
            charts.throughput.data.datasets[0].data = data.map(item => item.tps);
            charts.throughput.data.datasets[1].data = data.map(item => item.qps);
            charts.throughput.update();

            // 更新错误统计
            const totalRequests = data.reduce((sum, item) => sum + item.totalRequests, 0);
            const totalErrors = data.reduce((sum, item) => sum + (item.totalRequests * item.errorRate / 100), 0);
            const successRequests = totalRequests - totalErrors;
            
            charts.error.data.datasets[0].data = [successRequests, totalErrors];
            charts.error.update();
        }

        // 加载应用统计
        function loadApplicationStats() {
            return fetch('/api/statistics/applications')
                .then(response => response.json())
                .then(data => {
                    updateApplicationTable(data);
                })
                .catch(error => {
                    console.error('Error loading application stats:', error);
                });
        }

        // 更新应用统计表格
        function updateApplicationTable(data) {
            const tbody = document.getElementById('applicationStatsTable');
            tbody.innerHTML = '';

            data.forEach(app => {
                const row = document.createElement('tr');
                
                const statusBadge = getStatusBadge(app.errorRate, app.avgResponseTime);
                
                row.innerHTML = `
                    <td><strong>${app.applicationName}</strong></td>
                    <td>${app.currentConnections}</td>
                    <td>${app.peakConnections}</td>
                    <td>${app.totalRequests}</td>
                    <td>${app.successRate.toFixed(1)}%</td>
                    <td>${app.avgResponseTime.toFixed(1)}ms</td>
                    <td>${app.avgTps.toFixed(1)} TPS</td>
                    <td>${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 加载EventLoop统计
        function loadEventLoopStats() {
            return fetch('/api/statistics/eventloops')
                .then(response => response.json())
                .then(data => {
                    updateEventLoopTable(data);
                })
                .catch(error => {
                    console.error('Error loading EventLoop stats:', error);
                });
        }

        // 更新EventLoop统计表格
        function updateEventLoopTable(data) {
            const tbody = document.getElementById('eventLoopStatsTable');
            tbody.innerHTML = '';

            data.forEach(el => {
                const row = document.createElement('tr');
                
                const statusBadge = getEventLoopStatusBadge(el.isOverloaded, el.needsRebalancing);
                
                row.innerHTML = `
                    <td><strong>${el.eventLoopName}</strong></td>
                    <td>${el.currentChannels}</td>
                    <td>${el.peakChannels}</td>
                    <td>${el.currentQueueSize}</td>
                    <td>${el.cpuUsage.toFixed(1)}%</td>
                    <td>${el.avgLoad.toFixed(2)}</td>
                    <td>${el.errorRate.toFixed(1)}%</td>
                    <td>${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 获取状态徽章
        function getStatusBadge(errorRate, responseTime) {
            if (errorRate > 5 || responseTime > 1000) {
                return '<span class="metric-badge metric-danger">异常</span>';
            } else if (errorRate > 1 || responseTime > 500) {
                return '<span class="metric-badge metric-warning">警告</span>';
            } else {
                return '<span class="metric-badge metric-success">正常</span>';
            }
        }

        // 获取EventLoop状态徽章
        function getEventLoopStatusBadge(isOverloaded, needsRebalancing) {
            if (isOverloaded) {
                return '<span class="metric-badge metric-danger">过载</span>';
            } else if (needsRebalancing) {
                return '<span class="metric-badge metric-warning">需重平衡</span>';
            } else {
                return '<span class="metric-badge metric-success">正常</span>';
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshData();
            
            // 设置自动刷新
            setInterval(refreshData, 30000); // 每30秒刷新一次
        });
    </script>
</body>
</html>"